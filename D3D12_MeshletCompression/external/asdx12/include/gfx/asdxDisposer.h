//-----------------------------------------------------------------------------
// File : asdxDisposer.h
// Desc : Object Disposer.
// Copyright(c) Project Asura. All right reserved.
//-----------------------------------------------------------------------------
#pragma once

//-----------------------------------------------------------------------------
// Includes
//-----------------------------------------------------------------------------
#include <list>
#include <algorithm>
#include <fnd/asdxRef.h>
#include <fnd/asdxSpinLock.h>


namespace asdx {

///////////////////////////////////////////////////////////////////////////////
// Disposer class
///////////////////////////////////////////////////////////////////////////////
template<typename T>
class Disposer
{
    //=========================================================================
    // list of friend classes and methods.
    //=========================================================================
    /* NOTHING */

public:
    //=========================================================================
    // public variables.
    //=========================================================================
    static constexpr uint8_t kDefaultFrameCount = 4;

    //=========================================================================
    // public methods.
    //=========================================================================

    //-------------------------------------------------------------------------
    //! @brief      コンストラクタです.
    //-------------------------------------------------------------------------
    Disposer()
    : Disposer(kDefaultFrameCount)
    { /* DO_NOTHING */; }

    //-------------------------------------------------------------------------
    //! @brief      引数付きコンストラクタです.
    //! 
    //! @param[in]      frameCount      生存フレーム数.
    //-------------------------------------------------------------------------
    Disposer(uint8_t frameCount)
    { m_Lists.resize(frameCount); }

    //-------------------------------------------------------------------------
    //! @brief      デストラクタです.
    //-------------------------------------------------------------------------
    ~Disposer()
    { Clear(); }

    //-------------------------------------------------------------------------
    //! @brief      オブジェクトを登録します.
    //!
    //! @param[in]      pObject     登録するオブジェクト.
    //! @param[in]      lifeTime    生存フレーム数.
    //-------------------------------------------------------------------------
    void Push(T*& object)
    {
        if (object == nullptr)
        { return; }

        m_Lists.front().push_back(object);
        object = nullptr;

        m_Count++;
    }

    //-------------------------------------------------------------------------
    //! @brief      フレーム同期し，遅延解放を実行します.
    //-------------------------------------------------------------------------
    void FrameSync()
    {
        // 先頭を末端に移動し，前にずらす.
        std::rotate(m_Lists.begin(), (++m_Lists.begin()), m_Lists.end());

        auto& list = m_Lists.front();
        auto itr = list.begin();
        while(itr != list.end())
        {
            auto object = (*itr);
            if (object != nullptr)
            {
                object->Release();
                object = nullptr;
            }

            itr = list.erase(itr);
            m_Count--;
        }
        list.clear();
    }

    //-------------------------------------------------------------------------
    //! @brief      強制破棄を実行します.
    //-------------------------------------------------------------------------
    void Clear()
    {
        for(auto& list : m_Lists)
        {
            auto itr = list.begin();
            while(itr != list.end())
            {
                auto object = (*itr);
                if (object != nullptr)
                {
                    object->Release();
                    object = nullptr;
                }
                itr = list.erase(itr);
                m_Count--;
            }
            list.clear();
        }
    }

    //-------------------------------------------------------------------------
    //! @brief      登録数を取得します.
    //-------------------------------------------------------------------------
    uint32_t GetCount() const
    { return m_Count; }

    //-------------------------------------------------------------------------
    //! @brief      空かどうかチェックします.
    //-------------------------------------------------------------------------
    bool Empty() const
    { return m_Count == 0; }

private:
    //=========================================================================
    // private variables.
    //=========================================================================
    std::vector< std::list<T*> >    m_Lists;        //!< 遅延解放リスト. 
    uint32_t                        m_Count = 0;    //!< 登録数.

    //=========================================================================
    // private methods.
    //=========================================================================
    /* NOTHING */
};

} // namespace asdx
