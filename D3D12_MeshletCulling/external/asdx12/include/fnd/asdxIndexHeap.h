//-----------------------------------------------------------------------------
// File : asdxIndexHeap.h
// Desc : Index Heap.
// Copyright(c) Project Asura. All right reserved.
//-----------------------------------------------------------------------------
#pragma once

//-----------------------------------------------------------------------------
// Includes
//-----------------------------------------------------------------------------
#include <cstdint>
#include <fnd/asdxList.h>
#include <fnd/asdxSpinLock.h>


namespace asdx {

//-----------------------------------------------------------------------------
// Forward Declarations.
//-----------------------------------------------------------------------------
struct IndexHolder;


///////////////////////////////////////////////////////////////////////////////
// IndexHandle class
///////////////////////////////////////////////////////////////////////////////
class IndexHandle
{
    //=========================================================================
    // list of friend classes and methods.
    //=========================================================================
    friend class IndexHeap;

public:
    //=========================================================================
    // public variables.
    //=========================================================================
    static constexpr uint32_t INVALID_OFFSET = UINT32_MAX; //!< 無効なオフセット.

    //=========================================================================
    // public methods.
    //=========================================================================

    //-------------------------------------------------------------------------
    //! @brief      コンストラクタです.
    //-------------------------------------------------------------------------
    IndexHandle()
    : m_pHolder (nullptr)
    , m_pHeap   (nullptr)
    { /* DO_NOTHING */ }

    //-------------------------------------------------------------------------
    //! @brief      インデックスオフセットを取得します.
    //! 
    //! @return     インデックスオフセットを返却します.
    //-------------------------------------------------------------------------
    uint32_t GetOffset() const;

    //-------------------------------------------------------------------------
    //! @brief      インデックス数を取得します.
    //! 
    //! @return     インデックス数を返却します.
    //-------------------------------------------------------------------------
    uint32_t GetCount() const;

    //-------------------------------------------------------------------------
    //! @brief      ハンドルが有効かどうかチェックします.
    //! 
    //! @retval true    有効です.
    //! @retval false   無効です.
    //-------------------------------------------------------------------------
    bool IsValid() const;

private:
    //=========================================================================
    // private variables 
    //=========================================================================
    IndexHeap*      m_pHeap   = nullptr;
    IndexHolder*    m_pHolder = nullptr;

    //=========================================================================
    // private methods.
    //=========================================================================

    //-------------------------------------------------------------------------
    //! @brief      引数付きコンストラクタです.
    //-------------------------------------------------------------------------
    IndexHandle(IndexHeap* heap, IndexHolder* holder)
    : m_pHeap   (heap)
    , m_pHolder (holder)
    { /* DO_NOTHING */ }
};

///////////////////////////////////////////////////////////////////////////////
// IndexHeap class
///////////////////////////////////////////////////////////////////////////////
class IndexHeap
{
    //=========================================================================
    // list of friend classes and methods.
    //=========================================================================
    /* NOTHING */

public:
    //=========================================================================
    // public variables.
    //=========================================================================
    /* NOTHING */

    //=========================================================================
    // public methods.
    //=========================================================================

    //-------------------------------------------------------------------------
    //! @brief      コンストラクタです.
    //-------------------------------------------------------------------------
    IndexHeap() = default;

    //-------------------------------------------------------------------------
    //! @brief      デストラクタです.
    //-------------------------------------------------------------------------
    ~IndexHeap();

    //-------------------------------------------------------------------------
    //! @brief      初期化処理を行います.
    //! 
    //! @param[in]      count       確保するインデックス数.
    //! @retval true    初期化に成功.
    //! @retval false   初期化に失敗.
    //-------------------------------------------------------------------------
    bool Init(uint32_t count);

    //-------------------------------------------------------------------------
    //! @brief      終了処理を行います.
    //-------------------------------------------------------------------------
    void Term();

    //-------------------------------------------------------------------------
    //! @brief      初期化済みかどうかチェックします.
    //! 
    //! @retval true    初期化済みです.
    //! @retval false   未初期化です.
    //-------------------------------------------------------------------------
    bool IsInit() const;

    //-------------------------------------------------------------------------
    //! @brief      インデックスを確保します.
    //!
    //! @param[in]      count       確保するインデックス数.
    //! @return     インデックスハンドルを返却します.
    //-------------------------------------------------------------------------
    IndexHandle Alloc(uint32_t count);

    //-------------------------------------------------------------------------
    //! @brief      インデックスを解放します.
    //! 
    //! @param[in]      handle      解放するインデックス.
    //-------------------------------------------------------------------------
    void Free(IndexHandle& handle);

    //-------------------------------------------------------------------------
    //! @brief      メモリコンパクションを実行します.
    //! 
    //! @return     メモリ移動が発生したら true を返却します.
    //-------------------------------------------------------------------------
    bool Compact();

    //-------------------------------------------------------------------------
    //! @brief      使用数を取得します.
    //! 
    //! @return     使用数を返却します.
    //-------------------------------------------------------------------------
    uint32_t GetUsedCount() const;

    //-------------------------------------------------------------------------
    //! @brief      未使用数を取得します.
    //! 
    //! @return     未使用数を返却します.
    //-------------------------------------------------------------------------
    uint32_t GetFreeCount() const;

    //-------------------------------------------------------------------------
    //! @brief      インデックスオフセットを取得します.
    //! 
    //! @param[in]      pHolder     インデックスホルダー.
    //! @return     インデックスオフセットを返却します.
    //-------------------------------------------------------------------------
    uint32_t GetOffset(const IndexHolder* pHolder);

    //-------------------------------------------------------------------------
    //! @brief      インデックス数を取得します.
    //! 
    //! @param[in]      pHolder     インデックスホルダー.
    //! @return     インデックス数を返却します.
    //-------------------------------------------------------------------------
    uint32_t GetCount(const IndexHolder* pHolder);

private:
    //=========================================================================
    // private variables.
    //=========================================================================
    bool                m_Init      = false;
    IndexHolder*        m_Holders   = nullptr;
    uint32_t            m_Capacity  = 0;
    uint32_t            m_UsedCount = 0;
    List<IndexHolder>   m_FreeList;
    List<IndexHolder>   m_UsedList;
    SpinLock            m_Lock;

    //=========================================================================
    // private methods.
    //=========================================================================
    /* NOTHING */
};

} // namespace asdx
