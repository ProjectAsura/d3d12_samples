//-----------------------------------------------------------------------------
// File : asdxJobSystem.h
// Desc : Job System.
// Copyright(c) Project Asura. All right reserved.
//-----------------------------------------------------------------------------
#pragma once

//-----------------------------------------------------------------------------
// Includes
//-----------------------------------------------------------------------------
#include <cstdint>


namespace asdx {

///////////////////////////////////////////////////////////////////////////////
// JobListener interface
///////////////////////////////////////////////////////////////////////////////
struct JobListener
{
    //-------------------------------------------------------------------------
    //! @brief      デストラクタです.
    //-------------------------------------------------------------------------
    virtual ~JobListener() {}

    //-------------------------------------------------------------------------
    //! @brief      ジョブ実行関数です.
    //! 
    //! @param[in]      userId      ユーザーIDです.
    //-------------------------------------------------------------------------
    virtual void OnRun(uint32_t userId) = 0;
};

///////////////////////////////////////////////////////////////////////////////
// Job structure
///////////////////////////////////////////////////////////////////////////////
struct Job
{
    uint32_t        UserId      = UINT32_MAX;   //!< ユーザーID.
    uint32_t        StartPoint  = UINT32_MAX;   //!< ジョブ開始点.
    uint32_t        SyncPoint   = UINT32_MAX;   //!< ジョブ同期点.
    JobListener*    pListener   = nullptr;      //!< ジョブリスナー.

    //-------------------------------------------------------------------------
    //! @brief      コンストラクタです.
    //-------------------------------------------------------------------------
    Job() = default;

    //-------------------------------------------------------------------------
    //! @brief      引数付きコンストラクタです.
    //! 
    //! @param[in]      userId          ユーザーID.
    //! @param[in]      startPoint      ジョブ開始点.
    //! @param[in]      syncPoint       ジョブ同期点.
    //! @param[in]      pListener       ジョブリスナー.
    //-------------------------------------------------------------------------
    Job
    (
        uint32_t        userId,
        uint32_t        startPoint,
        uint32_t        syncPoint,
        JobListener*    listener
    )
    : UserId    (userId)
    , StartPoint(startPoint)
    , SyncPoint (syncPoint)
    , pListener (listener)
    { /* DO_NOTHING */ }
};

///////////////////////////////////////////////////////////////////////////////
// IJobSystem interface
///////////////////////////////////////////////////////////////////////////////
struct IJobSystem
{
    //-------------------------------------------------------------------------
    //! @brief      デストラクタです.
    //-------------------------------------------------------------------------
    virtual ~IJobSystem() {}

    //-------------------------------------------------------------------------
    //! @brief      ジョブを登録します.
    //! 
    //! @param[in]      job     登録するジョブです.
    //! @retval true    登録に成功.
    //! @retval false   登録に失敗.
    //-------------------------------------------------------------------------
    virtual bool Add(const Job& job) = 0;

    //-------------------------------------------------------------------------
    //! @brief      ジョブを削除します.
    //! 
    //! @param[in]      job     削除するジョブです.
    //! @retval true    削除に成功.
    //! @retval false   削除に失敗.
    //-------------------------------------------------------------------------
    virtual bool Remove(const Job& job) = 0;

    //-------------------------------------------------------------------------
    //! @brief      ジョブを実行します.
    //-------------------------------------------------------------------------
    virtual void Run() = 0;
};

//-----------------------------------------------------------------------------
//! @brief      ジョブシステムを初期化します.
//! 
//! @param[in]      syncPointCount      同期ポイント数.
//! @param[in]      threadCount         スレッド数.
//! @retval true    初期化に成功.
//! @retval false   初期化に失敗.
//-----------------------------------------------------------------------------
bool InitJobSystem(uint32_t syncPointCount, uint8_t threadCount);

//-----------------------------------------------------------------------------
//! @brief      ジョブシステムを終了します.
//-----------------------------------------------------------------------------
void TermJobSystem();

//-----------------------------------------------------------------------------
//! @brief      ジョブシステムを取得します.
//! 
//! @return     ジョブシステムを返却します.
//-----------------------------------------------------------------------------
IJobSystem* GetJobSystem();

} // namespace asdx
